#pragma once

#include "../interfaces/topic_handler.hpp"
#include <unordered_map>
#include <functional>

namespace {{ args.package.name |regex_replace('[^A-Za-z0-9]', '_')}} {

/**
 * @brief Concrete implementation of TopicHandler using ROS2 publishers and subscribers
 * 
 * This class manages all topic-related ROS2 communication through composition
 */
class RosTopicHandler : public TopicHandler {
public:
    explicit RosTopicHandler(rclcpp::Node* node);
    ~RosTopicHandler() override = default;

    void initialize() override;
    void shutdown() override;

{%- if args.ros is defined %}
{%- if args.ros.interfaces is defined %}
    // === Publisher interface implementations ===
{%- for interface in args.ros.interfaces if interface.type == "topic" and interface.direction == "out" %}
    {%- if args.lookup.interfaces.msgs[interface.msgs] is defined %}
    {%- set lu = namespace(cpp_data_type = args.lookup.interfaces.msgs[interface.msgs].cpp_data_type,
                           ros_data_type = args.lookup.interfaces.msgs[interface.msgs].ros_data_type) %}
    void publish_{{ interface.name|regex_replace('[^A-Za-z0-9]', '_') }}(
    {%- for field in lu.cpp_data_type %}
        const {{ field.type }} &msg_{{ field.name }}{% if not loop.last %}, {% endif %}
    {%- endfor %}) override;
    {%- endif %}
{%- endfor %}

    // === Subscriber callback registration ===
{%- for interface in args.ros.interfaces if interface.type == "topic" and interface.direction == "in" %}
    {%- if args.lookup.interfaces.msgs[interface.msgs] is defined %}
    {%- set lu = namespace(ros_data_type = args.lookup.interfaces.msgs[interface.msgs].ros_data_type) %}
    void set_{{ interface.name|regex_replace('[^A-Za-z0-9]', '_') }}_callback(
        std::function<void(const {{ lu.ros_data_type }} &)> callback) override;
    {%- endif %}
{%- endfor %}
{%- endif %}
{%- endif %}

private:
{%- if args.ros is defined %}
{%- if args.ros.interfaces is defined %}
    // === Publishers ===
{%- for interface in args.ros.interfaces if interface.type == "topic" and interface.direction == "out" %}
    {%- if args.lookup.interfaces.msgs[interface.msgs] is defined %}
    {%- set lu = namespace(ros_data_type = args.lookup.interfaces.msgs[interface.msgs].ros_data_type) %}
    rclcpp::Publisher<{{ lu.ros_data_type }}>::SharedPtr pub_{{ interface.name|regex_replace('[^A-Za-z0-9]', '_') }}_;
    {%- endif %}
{%- endfor %}

    // === Subscribers ===
{%- for interface in args.ros.interfaces if interface.type == "topic" and interface.direction == "in" %}
    {%- if args.lookup.interfaces.msgs[interface.msgs] is defined %}
    {%- set lu = namespace(ros_data_type = args.lookup.interfaces.msgs[interface.msgs].ros_data_type) %}
    rclcpp::Subscription<{{ lu.ros_data_type }}>::SharedPtr sub_{{ interface.name|regex_replace('[^A-Za-z0-9]', '_') }}_;
    std::function<void(const {{ lu.ros_data_type }} &)> callback_{{ interface.name|regex_replace('[^A-Za-z0-9]', '_') }}_;
    {%- endif %}
{%- endfor %}

    // === Internal callback methods ===
{%- for interface in args.ros.interfaces if interface.type == "topic" and interface.direction == "in" %}
    {%- if args.lookup.interfaces.msgs[interface.msgs] is defined %}
    {%- set lu = namespace(ros_data_type = args.lookup.interfaces.msgs[interface.msgs].ros_data_type) %}
    void internal_callback_{{ interface.name|regex_replace('[^A-Za-z0-9]', '_') }}(const {{ lu.ros_data_type }} & msg);
    {%- endif %}
{%- endfor %}
{%- endif %}
{%- endif %}
};

} // namespace {{ args.package.name |regex_replace('[^A-Za-z0-9]', '_')}}