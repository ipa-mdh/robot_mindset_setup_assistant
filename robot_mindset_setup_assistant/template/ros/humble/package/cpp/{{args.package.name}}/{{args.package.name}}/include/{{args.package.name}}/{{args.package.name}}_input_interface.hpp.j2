#pragma once

#include <string>
#include <spdlog/spdlog.h>

{#- Initialize an empty list to collect unique message types #}
{%- set unique_msgs = [] %}
{%- set ns = namespace(add_actionlib=false) -%}

{%- if args.ros is defined %}
{%- if args.ros.interfaces is defined %}
{%- for interface in args.ros.interfaces if interface.direction == "in" %}
{#- Check if the message type is already in the list #}
{%- if interface.msgs not in unique_msgs -%}
{#- If not, add it to the list #}
{%- set unique_msgs = unique_msgs.append(interface.msgs) -%}
{%- endif -%}

{#- Check if the interface is an action and set the flag #}
{%- if interface.type == "action" -%}
{%- set ns.add_actionlib = true -%}
{%- endif -%}
{%- endfor %}
{%- endif %}
{%- endif %}

// Include message headers based on the Robot Mindset Setup Assistant configuration
{%- if ns.add_actionlib %}
#include <rclcpp_action/rclcpp_action.hpp>
{%- endif %}

{%- for msgs in unique_msgs|sort %}
{%- if msgs in args.lookup.interfaces.msgs %}
{%- set lu = namespace(include=args.lookup.interfaces.msgs[msgs].include) %}
#include "{{ lu.include }}.hpp"
{%- else %}
// implementation is required for msgs: {{ msgs }}
{%- endif %}
{%- endfor %}

namespace {{ args.package.name |regex_replace('[^A-Za-z0-9]', '_')}} 
{

class LogicModuleInputInterface 
{
public:
    virtual ~LogicModuleInputInterface() = default;

    // === Interface functions ===
    // handle ROS subscriptions
{%- if args.ros is defined %}
{%- if args.ros.interfaces is defined %}
{%- for interface in args.ros.interfaces if interface.type == "topic" and interface.direction == "in" %}
    // {{ interface.description }}
{%- if interface.msgs in args.lookup.interfaces.msgs %}
{%- set lu = namespace(ros_data_type=args.lookup.interfaces.msgs[interface.msgs].ros_data_type,
                        cpp_data_type=args.lookup.interfaces.msgs[interface.msgs].cpp_data_type) %}
    virtual void process_sub_{{ interface.name|regex_replace('[^A-Za-z0-9]', '_') }}(
    {%- for field in lu.cpp_data_type %}
        const {{ field.type }} &msg_{{ field.name }}{%if not loop.last %}, {% endif %}
    {%- endfor %}) = 0;
{%- else %}
    // For other message types, implementation is required
    // interface:
    // - name: {{ interface.name|regex_replace('[^A-Za-z0-9]', '_') }}
    // - msgs: {{ interface.msgs }}
    // virtual void process_sub_{{ interface.name|regex_replace('[^A-Za-z0-9]', '_') }}(const {{ interface.msgs }} &msg)
    // {
    //     spdlog::debug("Logic Module (non-ROS): Received on topic {{ interface.name|regex_replace('[^A-Za-z0-9]', '_') }}: {{ field.name }}: {}", msg_{{ field.name }});
    // }
{%- endif %}
{%- endfor %}
{%- endif %}
{%- endif %}


    // === Service call ===
{%- if args.ros is defined %}
{%- if args.ros.interfaces is defined %}
{%- for interface in args.ros.interfaces if interface.type == "service" and interface.direction == "out" %}
    // {{ interface.description }}
{%- if interface.msgs in args.lookup.interfaces.msgs %}
{%- set lu = namespace(ros_data_type=args.lookup.interfaces.msgs[interface.msgs].ros_data_type,
                       cpp_data_type=args.lookup.interfaces.msgs[interface.msgs].cpp_data_type) %}
    virtual void process_srv_{{ interface.name|regex_replace('[^A-Za-z0-9]', '_') }}(
    {%- for field in lu.cpp_data_type.req %}
        const {{ field.type }} &req_{{ field.name }}{%- if not loop.last or lu.cpp_data_type.res|length > 0 %}, {% endif %}
    {%- endfor %}
    {%- for field in lu.cpp_data_type.res %}
        {{ field.type }} &res_{{ field.name }}{%- if not loop.last %}, {% endif %}
    {%- endfor %}) = 0;
{%- endif %}
{% endfor %}
{%- endif %}
{%- endif %}


// === Action server execution methods ===
{%- if args.ros is defined %}
{%- if args.ros.interfaces is defined %}
{%- for interface in args.ros.interfaces if interface.type == "action" and interface.direction == "out" %}
{%- if interface.msgs in args.lookup.interfaces.msgs %}
{%- set lu = namespace(ros_data_type=args.lookup.interfaces.msgs[interface.msgs].ros_data_type) %}
    // {{ interface.description }}
    // Action server execution for {{ interface.name|regex_replace('[^A-Za-z0-9]', '_') }}
    virtual void execute_action_{{ interface.name|regex_replace('[^A-Za-z0-9]', '_') }}(
        const std::shared_ptr<const {{ lu.ros_data_type }}::Goal> goal,
        std::shared_ptr<{{ lu.ros_data_type }}::Feedback> feedback,
        std::shared_ptr<{{ lu.ros_data_type }}::Result> result,
        std::function<bool()> is_canceling,
        std::function<void(std::shared_ptr<{{ lu.ros_data_type }}::Feedback>)> publish_feedback,
        std::function<bool()> is_ok) = 0;
{%- else %}
    // {{ interface.name|regex_replace('[^A-Za-z0-9]', '_') }}: Unknown action interface.msgs: {{ interface.msgs }}
{%- endif %}
{%- endfor %}
{%- endif %}
{%- endif %}

// === Action client callbacks ===
{%- if args.ros is defined %}
{%- if args.ros.interfaces is defined %}
{%- for interface in args.ros.interfaces if interface.type == "action" and interface.direction == "in" %}
{%- if interface.msgs in args.lookup.interfaces.msgs %}
{%- set lu = namespace(ros_data_type=args.lookup.interfaces.msgs[interface.msgs].ros_data_type) %}
    // {{ interface.description }}
    // Action client callbacks for {{ interface.name|regex_replace('[^A-Za-z0-9]', '_') }}
    virtual void goal_response_callback_{{ interface.name|regex_replace('[^A-Za-z0-9]', '_') }}(const rclcpp_action::ClientGoalHandle<{{ lu.ros_data_type }}>::SharedPtr & goal_handle) = 0;
    virtual void feedback_callback_{{ interface.name|regex_replace('[^A-Za-z0-9]', '_') }}(
        rclcpp_action::ClientGoalHandle<{{ lu.ros_data_type }}>::SharedPtr goal_handle,
        const std::shared_ptr<const {{ lu.ros_data_type }}::Feedback> feedback) = 0;
    virtual void result_callback_{{ interface.name|regex_replace('[^A-Za-z0-9]', '_') }}(const rclcpp_action::ClientGoalHandle<{{ lu.ros_data_type }}>::WrappedResult & result) = 0;
{%- else %}
    // {{ interface.name|regex_replace('[^A-Za-z0-9]', '_') }}: Unknown action interface.msgs: {{ interface.msgs }}
{%- endif %}
{%- endfor %}
{%- endif %}
{%- endif %}

// === Service client callbacks ===
{%- if args.ros is defined %}
{%- if args.ros.interfaces is defined %}
{%- for interface in args.ros.interfaces if interface.type == "service" and interface.direction == "in" %}
{%- if interface.msgs in args.lookup.interfaces.msgs %}
{%- set lu = namespace(ros_data_type=args.lookup.interfaces.msgs[interface.msgs].ros_data_type) %}
    // {{ interface.description }}
    // Service client callback for {{ interface.name|regex_replace('[^A-Za-z0-9]', '_') }}
    virtual void interface_srv_{{ interface.name|regex_replace('[^A-Za-z0-9]', '_') }}_callback(
        rclcpp::Client<{{ lu.ros_data_type }}>::SharedFuture response) = 0;
{%- else %}
    // {{ interface.name|regex_replace('[^A-Za-z0-9]', '_') }}: Unknown service interface.msgs: {{ interface.msgs }}
{%- endif %}
{%- endfor %}
{%- endif %}
{%- endif %}

// === Parameter callbacks ===
{%- if args.ros is defined %}
{%- if args.ros.interfaces is defined %}
{%- for interface in args.ros.interfaces if interface.type == "parameter" %}
{%- if interface.msgs in args.lookup.interfaces.msgs %}
{%- set lu = namespace(cpp_data_type=args.lookup.interfaces.msgs[interface.msgs].cpp_data_type) %}
    // {{ interface.description }}
    // Parameter callback for {{ interface.name|regex_replace('[^A-Za-z0-9]', '_') }}
    {%- for field in lu.cpp_data_type %}
    virtual void process_param_{{ interface.name|regex_replace('[^A-Za-z0-9]', '_') }}(const {{ field.type }}& data) = 0;
    {%- endfor %}
{%- else %}
    // {{ interface.name|regex_replace('[^A-Za-z0-9]', '_') }}: Unknown parameter interface.msgs: {{ interface.msgs }}
{%- endif %}
{%- endfor %}
{%- endif %}
{%- endif %}

};

} // namespace {{ args.package.name |regex_replace('[^A-Za-z0-9]', '_')}}
